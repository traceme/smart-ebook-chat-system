# 电子书智能对话系统 PRD

## Context

### Overview
本项目旨在开发一个基于Web的电子书智能对话系统。该系统能够接收用户上传的多种格式电子书（PDF、EPUB、TXT等），自动将其转换为结构化的Markdown格式，并通过先进的向量化技术建立知识索引。用户可以通过Gmail风格的对话界面与书籍内容进行自然语言交互，系统支持OpenAI、Claude、Gemini等多种大语言模型，为用户提供精准、高效的内容理解和问答服务。这个工具主要面向个人读者、教育工作者、企业知识管理等场景，提供一种革新性的阅读和学习体验。

## Core Features

### 1. 多格式电子书上传与管理
- **功能**: 系统支持批量上传PDF、EPUB、TXT、DOCX等主流电子书格式，提供拖拽上传、断点续传等便捷功能
- **重要性**: 这是系统的入口功能，良好的上传体验直接影响用户的第一印象和使用意愿
- **工作原理**: 
  - 前端使用React实现分片上传，支持5MB/chunk的并发上传
  - 后端生成S3预签名URL，确保上传安全性
  - 实现SHA-256去重检查，避免重复存储
  - WebSocket实时推送上传进度

### 2. 文档格式转换（使用MarkItDown）
- **功能**: 将上传的各种格式文档自动转换为结构化的Markdown格式
- **重要性**: Markdown格式便于后续的文本处理、索引和展示，是实现智能对话的基础
- **工作原理**:
  - 集成Microsoft MarkItDown开源项目进行格式转换
  - 使用Celery实现异步任务队列，支持大文件处理
  - 保留原文档的结构信息（标题、段落、表格、图片占位等）
  - 实现3次自动重试机制，确保转换成功率≥97%

### 3. 知识向量化与索引（使用memvidg）
- **功能**: 将Markdown文本切分成语义片段，并通过向量化建立可检索的知识库
- **重要性**: 这是实现精准语义检索和高质量对话的核心技术
- **工作原理**:
  - 使用memvidg将文本切分为1-2k tokens的语义块
  - 调用text-embedding-3 API生成向量表示
  - 存储到Qdrant向量数据库，支持高效相似度搜索
  - 构建倒排索引，支持混合检索策略

### 4. 智能对话系统
- **功能**: 用户可以与上传的书籍内容进行自然语言对话，获得精准的答案和引用
- **重要性**: 这是系统的核心价值，将静态的书籍转化为可交互的知识助手
- **工作原理**:
  - 向量检索：对用户问题进行向量化，检索top-8相关片段
  - Rerank重排序：使用bge-reranker-base模型优化检索结果
  - Prompt构建：将检索结果和用户问题组合成上下文
  - LLM生成：调用选定的大模型生成答案
  - 引用定位：返回答案对应的原文页码和高亮显示

### 5. 多模型灵活切换
- **功能**: 支持在OpenAI GPT-4o、Claude 3.5、Gemini 2.5 Pro之间灵活切换
- **重要性**: 满足不同场景下对成本、速度、效果的平衡需求
- **工作原理**:
  - 实现统一的LLMProvider抽象接口
  - 支持流式响应（SSE）
  - 实时成本估算和Token计数
  - 自动降级和熔断机制

### 6. Gmail风格用户界面
- **功能**: 提供熟悉、优雅的Gmail风格界面，降低学习成本
- **重要性**: 良好的UI/UX是用户持续使用的关键
- **工作原理**:
  - 使用Material-UI v6组件库
  - 左侧文档列表，支持标签分类和搜索
  - 右侧对话区域，支持Markdown渲染
  - 响应式设计，适配移动端（≥360px）

## User Experience

### 用户画像
1. **个人阅读者**：希望快速理解和查询技术书籍、教材内容的学生和职场人士
2. **培训讲师**：需要快速备课、现场答疑的教育工作者
3. **企业知识管理员**：负责构建和维护企业内部知识库的IT人员
4. **出版社运营**：希望为读者提供增值服务的内容运营人员

### 关键用户流程
1. **注册登录**：用户通过邮箱或OAuth（Google/GitHub）注册登录
2. **上传书籍**：拖拽或选择文件批量上传，查看转换进度
3. **选择书籍**：从文档列表中选择要对话的书籍
4. **开始对话**：在对话框输入问题，选择AI模型
5. **查看答案**：获得带引用的答案，可以查看原文位置
6. **管理文档**：对文档进行分类、搜索、删除等操作

### UI/UX考虑
- **熟悉性**：采用Gmail风格，用户无需学习新界面
- **响应性**：首屏加载≤1秒，对话响应P95≤4秒
- **可访问性**：支持键盘导航，符合WCAG标准
- **实时反馈**：上传进度、转换状态、对话流式响应
- **错误处理**：友好的错误提示和恢复建议

## Technical Architecture

### 系统组件
```
┌─────────────────────────────────────────────────────┐
│                   前端层（React + Gatsby）            │
├─────────────────────────────────────────────────────┤
│  认证模块 │ 文档管理 │ 对话界面 │ 设置中心  
└─────────────────────────────────────────────────────┘
                            │
                     REST API / WebSocket
                            │
┌─────────────────────────────────────────────────────┐
│                   API网关（FastAPI）                  │
├─────────────────────────────────────────────────────┤
│  路由管理 │ 认证中间件 │ 
└─────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│   业务服务层    │                    │   异步任务层     │
├────────────────┤                    ├─────────────────┤
│ 用户服务       │                    │ 转换Worker      │
│ 文档服务       │                    │ 索引Worker      │
│ 对话服务       │                    │ 通知Worker      │
│               │                    └─────────────────┘
└────────────────┘                              │
        │                                       │
        └───────────────┬───────────────────────┘
                        │
┌───────────────────────┴────────────────────────────┐
│                      数据层                          │
├────────────────────────────────────────────────────┤
│ PostgreSQL │ Redis │ 消息队列  │
└────────────────────────────────────────────────────┘
